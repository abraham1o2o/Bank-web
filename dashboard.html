<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureBank - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
            text-decoration: none;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .welcome-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .balance-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .balance-amount {
            font-size: 36px;
            font-weight: bold;
            color: #333;
        }

        .account-number {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .transactions-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-size: 14px;
            color: #666;
            border-bottom: 2px solid #e0e0e0;
        }

        .transactions-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }

        .transactions-table tr:hover {
            background: #f8f9fa;
        }

        .amount-positive {
            color: #4caf50;
            font-weight: 600;
        }

        .amount-negative {
            color: #f44336;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
<div class="header">
    <div class="header-content">
        <div class="logo">üè¶ SecureBank</div>
        <div class="user-info">
            <span>Welcome, <span th:text="${user.username}">User</span></span>
            <a href="/logout" class="logout-btn">Logout</a>
        </div>
    </div>
</div>

<div class="container">
    <div class="welcome-card">
        <div class="balance-display">
            <div>
                <h1>Account Balance</h1>
                <div class="balance-amount">$<span id="balance" th:text="${#numbers.formatDecimal(user.balance, 1, 2)}">0.00</span></div>
                <div class="account-number">Account: <span id="accountNumber" th:text="${user.accountNumber}">ACC123456789</span></div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalDeposits">0</div>
                    <div class="stat-label">Total Deposits</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalWithdrawals">0</div>
                    <div class="stat-label">Total Withdrawals</div>
                </div>
            </div>
        </div>
    </div>

    <div class="alert alert-success" id="successAlert"></div>
    <div class="alert alert-error" id="errorAlert"></div>

    <div class="grid">
        <div class="card">
            <h2>üí∞ Deposit Funds</h2>
            <form id="depositForm">
                <div class="form-group">
                    <label for="depositAmount">Amount ($)</label>
                    <input type="number" id="depositAmount" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label for="depositDesc">Description (Optional)</label>
                    <input type="text" id="depositDesc" placeholder="e.g., Salary, Gift">
                </div>
                <button type="submit" class="btn btn-success">Deposit</button>
            </form>
        </div>

        <div class="card">
            <h2>üí∏ Withdraw Funds</h2>
            <form id="withdrawForm">
                <div class="form-group">
                    <label for="withdrawAmount">Amount ($)</label>
                    <input type="number" id="withdrawAmount" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label for="withdrawDesc">Description (Optional)</label>
                    <input type="text" id="withdrawDesc" placeholder="e.g., Bills, Shopping">
                </div>
                <button type="submit" class="btn btn-danger">Withdraw</button>
            </form>
        </div>
    </div>

    <div class="card">
        <h2>üìä Recent Transactions</h2>
        <div id="transactionsContainer">
            <table class="transactions-table">
                <thead>
                <tr>
                    <th>Date & Time</th>
                    <th>Type</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Balance After</th>
                    <th>Reference</th>
                </tr>
                </thead>
                <tbody id="transactionsList">
                <!-- Server-side transactions -->
                <tr th:each="tx : ${recentTransactions}" th:if="${recentTransactions != null and !recentTransactions.isEmpty()}">
                    <td th:text="${#temporals.format(tx.timestamp, 'MM/dd/yyyy HH:mm')}">Date</td>
                    <td th:text="${tx.type}">Type</td>
                    <td th:text="${tx.description ?: '-'}">Description</td>
                    <td th:class="${tx.type == 'DEPOSIT'} ? 'amount-positive' : 'amount-negative'"
                        th:text="${tx.type == 'DEPOSIT'} ? '+' + ${#numbers.formatDecimal(tx.amount, 1, 2)} : '-' + ${#numbers.formatDecimal(tx.amount, 1, 2)}">Amount</td>
                    <td th:text="${#numbers.formatDecimal(tx.balanceAfter, 1, 2)}">Balance</td>
                    <td th:text="${tx.referenceNumber}">Reference</td>
                </tr>
                </tbody>
            </table>
            <div class="empty-state" id="emptyState" th:if="${recentTransactions == null or recentTransactions.isEmpty()}" style="display:block;">
                No transactions yet
            </div>
        </div>
    </div>
</div>

<script>
    // Initialize dashboard with user data
    let currentBalance = 0;

    // User data from Thymeleaf
        const userData = {
        username: /*[[${user.username}]]*/ 'User',
            balance: /*[[${user.balance}]]*/ 0,
        accountNumber: /*[[${user.accountNumber}]]*/ 'ACC123456789',
        transactions: /*[[${recentTransactions}]]*/ []
    };
    
    // Debug: Log the actual data being passed from server
    console.log('Server data - Username:', /*[[${user.username}]]*/ 'User');
        console.log('Server data - Balance:', /*[[${user.balance}]]*/ 0);
    console.log('Server data - Transactions:', /*[[${recentTransactions}]]*/ []);

    // Show success message
    function showSuccess(message) {
        const alert = document.getElementById('successAlert');
        alert.textContent = message;
        alert.style.display = 'block';
        setTimeout(() => {
            alert.style.display = 'none';
        }, 3000);
    }

    // Show error message
    function showError(message) {
        const alert = document.getElementById('errorAlert');
        alert.textContent = message;
        alert.style.display = 'block';
        setTimeout(() => {
            alert.style.display = 'none';
        }, 3000);
    }

    // Update balance display
    function updateBalance(newBalance) {
        currentBalance = newBalance;
        document.getElementById('balance').textContent = parseFloat(newBalance).toFixed(2);
    }

    // Format date
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    // Load transactions
    function loadTransactions(transactions) {
        const tbody = document.getElementById('transactionsList');
        const emptyState = document.getElementById('emptyState');

        if (!transactions || transactions.length === 0) {
            tbody.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';
        tbody.innerHTML = '';

        let deposits = 0;
        let withdrawals = 0;

        transactions.forEach(tx => {
            const row = tbody.insertRow();
            const isDeposit = tx.type === 'DEPOSIT';

            if (isDeposit) deposits++;
            else if (tx.type === 'WITHDRAWAL') withdrawals++;

            row.innerHTML = `
                <td>${formatDate(tx.timestamp)}</td>
                <td>${tx.type}</td>
                <td>${tx.description || '-'}</td>
                <td class="${isDeposit ? 'amount-positive' : 'amount-negative'}">
                    ${isDeposit ? '+' : '-'}${parseFloat(tx.amount).toFixed(2)}
                </td>
                <td>${parseFloat(tx.balanceAfter).toFixed(2)}</td>
                <td>${tx.referenceNumber}</td>
            `;
        });

        document.getElementById('totalDeposits').textContent = deposits;
        document.getElementById('totalWithdrawals').textContent = withdrawals;
    }

    // Handle deposit
    document.getElementById('depositForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const amount = document.getElementById('depositAmount').value;
        const description = document.getElementById('depositDesc').value;

        try {
            const response = await fetch('/deposit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `amount=${amount}&description=${encodeURIComponent(description)}`
            });

            const data = await response.json();

            if (data.success) {
                updateBalance(data.balance);
                showSuccess('Deposit successful!');
                document.getElementById('depositForm').reset();
                location.reload(); // Reload to get updated transactions
            } else {
                showError(data.message || 'Deposit failed');
            }
        } catch (error) {
            showError('Network error. Please try again.');
        }
    });

    // Handle withdrawal
    document.getElementById('withdrawForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const amount = document.getElementById('withdrawAmount').value;
        const description = document.getElementById('withdrawDesc').value;

        // Get current balance from the displayed value
        const currentBalanceDisplay = document.getElementById('balance').textContent;
        const currentBalanceValue = parseFloat(currentBalanceDisplay);
        
        console.log('Withdrawal attempt:', amount, 'Current balance:', currentBalanceValue);

        if (parseFloat(amount) > currentBalanceValue) {
            showError('Insufficient funds');
            return;
        }

        try {
            const response = await fetch('/withdraw', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `amount=${amount}&description=${encodeURIComponent(description)}`
            });

            const data = await response.json();

            if (data.success) {
                updateBalance(data.balance);
                showSuccess('Withdrawal successful!');
                document.getElementById('withdrawForm').reset();
                location.reload(); // Reload to get updated transactions
            } else {
                showError(data.message || 'Withdrawal failed');
            }
        } catch (error) {
            showError('Network error. Please try again.');
        }
    });

    // Initialize page with data
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Dashboard loaded with userData:', userData);
        
        // Get the actual Thymeleaf data from the page
        const serverUsername = /*[[${user.username}]]*/ 'User';
        const serverBalance = /*[[${user.balance}]]*/ 0;
        const serverTransactions = /*[[${recentTransactions}]]*/ [];
        
        console.log('Server Username:', serverUsername);
        console.log('Server Balance:', serverBalance);
        console.log('Server Transactions:', serverTransactions);
        
        // Update balance from server data
        const balanceElement = document.getElementById('balance');
        if (balanceElement) {
            currentBalance = parseFloat(serverBalance);
            balanceElement.textContent = currentBalance.toFixed(2);
            console.log('Updated balance display to:', currentBalance);
        }
        
        // Load transactions from server data
        if (serverTransactions && serverTransactions.length > 0) {
            console.log('Loading server transactions:', serverTransactions);
            loadTransactions(serverTransactions);
        } else {
            console.log('No server transactions found');
            // Show empty state
            const tbody = document.getElementById('transactionsList');
            const emptyState = document.getElementById('emptyState');
            if (tbody && emptyState) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
            }
        }
    });
</script>
</body>
</html>